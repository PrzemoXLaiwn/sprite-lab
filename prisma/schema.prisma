generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String        @id @default(uuid())
  email                 String        @unique
  name                  String?
  avatarUrl             String?       @map("avatar_url")
  credits               Int           @default(5)
  plan                  String        @default("FREE") // FREE, STARTER, PRO, UNLIMITED
  role                  String        @default("USER") // USER, SUPPORT, MODERATOR, ADMIN, OWNER (SEO)
  isLifetime            Boolean       @default(false) @map("is_lifetime") // Lifetime deal (no subscription renewal)
  stripeCustomerId      String?       @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?       @unique @map("stripe_subscription_id")
  stripePriceId         String?       @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime?    @map("stripe_current_period_end")
  isActive              Boolean       @default(true) @map("is_active")
  totalSpent            Float         @default(0) @map("total_spent") // Total money spent in GBP
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  lastActiveAt          DateTime?     @map("last_active_at") // For re-engagement emails
  emailPreferences      Json?         @map("email_preferences") // { marketing: true, welcomeEmailSent: true, etc. }

  // Profile fields
  username              String?       @unique
  bio                   String?
  website               String?
  socialTwitter         String?       @map("social_twitter")
  socialGithub          String?       @map("social_github")
  isProfilePublic       Boolean       @default(true) @map("is_profile_public")

  // Gamification
  totalLikesReceived    Int           @default(0) @map("total_likes_received")
  totalGenerationsPublic Int          @default(0) @map("total_generations_public")
  badges                String?       // JSON array of badge IDs

  // Daily Login Bonus
  loginStreak           Int           @default(0) @map("login_streak")
  lastLoginBonusAt      DateTime?     @map("last_login_bonus_at")
  totalBonusCredits     Int           @default(0) @map("total_bonus_credits")

  // Referral System
  referralCode          String?       @unique @map("referral_code") // User's unique referral code
  referredBy            String?       @map("referred_by") // ID of user who referred this user
  referralRewardClaimed Boolean       @default(false) @map("referral_reward_claimed") // Did referrer get reward?
  referralCount         Int           @default(0) @map("referral_count") // How many people they referred
  referralEarnings      Int           @default(0) @map("referral_earnings") // Total credits earned from referrals

  generations           Generation[]
  // pendingGenerations removed - no FK constraint to avoid Supabase timeout
  creditTransactions    CreditTransaction[]
  notifications         Notification[]
  communityPosts        CommunityPost[]
  postComments          PostComment[]
  postLikes             PostLike[]
  reports               Report[]       @relation("ReportedByUser")
  receivedReports       Report[]       @relation("ReportedUser")

  @@index([role])
  @@index([username])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("users")
}

model Generation {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  prompt        String
  fullPrompt    String?  @map("full_prompt")
  categoryId    String   @map("category_id")
  subcategoryId String   @map("subcategory_id")
  styleId       String   @map("style_id")
  imageUrl      String   @map("image_url")
  seed          Int?
  replicateCost Float?   @map("replicate_cost") // Cost in USD from Runware API (legacy field name)
  isPublic      Boolean  @default(false) @map("is_public") // Share to community gallery
  likes         Int      @default(0) // Community likes count
  createdAt     DateTime @default(now()) @map("created_at")

  user                User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis            ImageAnalysis?       // Auto-generated quality analysis
  verificationRecords VerificationRecord[] // Verification tests for hallucination fixes

  @@index([userId])
  @@index([createdAt])
  @@index([isPublic])
  @@map("generations")
}

// ===========================================
// BACKGROUND GENERATION QUEUE (Like Sora)
// ===========================================
model PendingGeneration {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")

  // Generation params
  prompt          String
  categoryId      String   @map("category_id")
  subcategoryId   String   @map("subcategory_id")
  styleId         String   @map("style_id")
  mode            String   @default("2d") // "2d" or "3d"
  seed            Int?

  // 3D specific
  model3DId       String?  @map("model_3d_id") // rodin, trellis, etc.
  quality3D       String?  @map("quality_3d") // low, medium, high

  // Status tracking
  status          String   @default("pending") // pending, processing, completed, failed
  progress        Int      @default(0) // 0-100
  progressMessage String?  @map("progress_message")
  errorMessage    String?  @map("error_message")

  // Credits (pre-deducted)
  creditsUsed     Int      @map("credits_used")

  // Result (when completed)
  resultUrl       String?  @map("result_url")
  resultSeed      Int?     @map("result_seed")
  generationId    String?  @map("generation_id") // ID of created Generation record

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Note: No foreign key to User to avoid Supabase timeout on constraint creation
  // userId is still used as a reference but without DB-level constraint

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("pending_generations")
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Int      // Positive for additions, negative for deductions
  type        String   // PURCHASE, GENERATION, REFUND, BONUS, ADMIN_GRANT
  description String?
  moneyAmount Float?   @map("money_amount") // Amount in USD for purchases
  adminId     String?  @map("admin_id") // ID of admin who granted credits
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@map("credit_transactions")
}

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("landing")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("waitlist_entries")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  type      String   @default("other") // bug, feature, other
  message   String
  email     String?
  context   String?  // JSON string with extra context (current page, browser, etc.)
  status    String   @default("new") // new, reviewed, resolved
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("feedback")
}

model Comment {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  generationId String   @map("generation_id")
  message      String
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([generationId])
  @@index([createdAt])
  @@map("comments")
}

model Like {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  generationId String   @map("generation_id")
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([userId, generationId])
  @@index([generationId])
  @@map("likes")
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // CREDIT_GRANT, SYSTEM, PROMO, etc.
  title     String
  message   String
  data      String?  // JSON string for extra data (e.g., amount, adminId)
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Community System
model CommunityPost {
  id           String        @id @default(cuid())
  userId       String        @map("user_id")
  generationId String?       @map("generation_id") // Optional link to generation
  title        String
  content      String?
  imageUrl     String?       @map("image_url")
  likesCount   Int           @default(0) @map("likes_count")
  commentsCount Int          @default(0) @map("comments_count")
  isHidden     Boolean       @default(false) @map("is_hidden") // Moderation
  isPinned     Boolean       @default(false) @map("is_pinned")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments     PostComment[]
  likes        PostLike[]
  reports      Report[]

  @@index([userId])
  @@index([createdAt])
  @@index([isHidden])
  @@index([isPinned])
  @@map("community_posts")
}

model PostComment {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  content   String
  isHidden  Boolean  @default(false) @map("is_hidden")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([postId])
  @@index([createdAt])
  @@map("post_comments")
}

model PostLike {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@map("post_likes")
}

model Report {
  id           String         @id @default(cuid())
  reporterId   String         @map("reporter_id")
  reportedUserId String?      @map("reported_user_id")
  postId       String?        @map("post_id")
  generationId String?        @map("generation_id")
  reason       String         // SPAM, INAPPROPRIATE, HARASSMENT, COPYRIGHT, OTHER
  description  String?
  status       String         @default("PENDING") // PENDING, REVIEWED, RESOLVED, DISMISSED
  moderatorId  String?        @map("moderator_id")
  moderatorNote String?       @map("moderator_note")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  reporter     User           @relation("ReportedByUser", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser User?          @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull)
  post         CommunityPost? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([postId])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

// ===========================================
// ANALYTICS & QUALITY TRACKING SYSTEM
// ===========================================

// Track user feedback on generations (thumbs up/down, ratings)
model GenerationFeedback {
  id            String   @id @default(cuid())
  generationId  String   @map("generation_id")
  userId        String   @map("user_id")
  rating        Int      // 1-5 stars or -1 (bad) / 1 (good) for thumbs
  feedbackType  String   @default("rating") @map("feedback_type") // rating, thumbs, report
  comment       String?  // Optional user comment
  issues        String?  // JSON array: ["wrong_style", "bad_quality", "not_matching_prompt"]
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([generationId, userId])
  @@index([generationId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("generation_feedback")
}

// Aggregate analytics per prompt pattern/category/style combination
model PromptAnalytics {
  id                String   @id @default(cuid())
  categoryId        String   @map("category_id")
  subcategoryId     String   @map("subcategory_id")
  styleId           String   @map("style_id")
  promptPattern     String   @map("prompt_pattern") // Normalized prompt keywords
  totalGenerations  Int      @default(0) @map("total_generations")
  avgRating         Float    @default(0) @map("avg_rating")
  positiveCount     Int      @default(0) @map("positive_count") // Thumbs up / 4-5 stars
  negativeCount     Int      @default(0) @map("negative_count") // Thumbs down / 1-2 stars
  regenerateRate    Float    @default(0) @map("regenerate_rate") // % of users who regenerate
  downloadRate      Float    @default(0) @map("download_rate") // % of users who download
  shareRate         Float    @default(0) @map("share_rate") // % of users who share publicly
  commonIssues      String?  @map("common_issues") // JSON: {"wrong_style": 5, "bad_quality": 3}
  bestPromptVariant String?  @map("best_prompt_variant") // The most successful full prompt
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([categoryId, subcategoryId, styleId, promptPattern])
  @@index([categoryId])
  @@index([styleId])
  @@index([avgRating])
  @@index([totalGenerations])
  @@map("prompt_analytics")
}

// Track user actions on generations (for learning what works)
model GenerationEvent {
  id            String   @id @default(cuid())
  generationId  String   @map("generation_id")
  userId        String   @map("user_id")
  eventType     String   @map("event_type") // view, download, share, regenerate, edit, delete, favorite
  metadata      String?  // JSON with extra info (e.g., time_spent_viewing)
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([generationId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("generation_events")
}

// Daily aggregated stats for admin dashboard
model DailyStats {
  id                 String   @id @default(cuid())
  date               DateTime @unique @db.Date
  totalGenerations   Int      @default(0) @map("total_generations")
  uniqueUsers        Int      @default(0) @map("unique_users")
  newUsers           Int      @default(0) @map("new_users")
  totalCreditsUsed   Int      @default(0) @map("total_credits_used")
  totalRevenue       Float    @default(0) @map("total_revenue") // In GBP
  avgRating          Float?   @map("avg_rating")
  topCategory        String?  @map("top_category")
  topStyle           String?  @map("top_style")
  topSubcategory     String?  @map("top_subcategory")
  errorRate          Float    @default(0) @map("error_rate") // % of failed generations
  avgGenerationTime  Float?   @map("avg_generation_time") // In seconds
  categoryBreakdown  String?  @map("category_breakdown") // JSON: {"characters": 50, "items": 30}
  styleBreakdown     String?  @map("style_breakdown") // JSON: {"pixel-art": 40, "anime": 20}
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([date])
  @@map("daily_stats")
}

// Store learned prompt improvements
model PromptImprovement {
  id                String   @id @default(cuid())
  categoryId        String   @map("category_id")
  subcategoryId     String   @map("subcategory_id")
  styleId           String   @map("style_id")
  originalKeywords  String   @map("original_keywords") // User's input words
  improvedPrompt    String   @map("improved_prompt") // AI-suggested improvement
  successRate       Float    @default(0) @map("success_rate") // % positive feedback
  usageCount        Int      @default(0) @map("usage_count")
  isActive          Boolean  @default(true) @map("is_active")
  source            String   @default("auto") // auto, manual, a/b_test
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([categoryId, subcategoryId, styleId, originalKeywords])
  @@index([categoryId])
  @@index([styleId])
  @@index([successRate])
  @@index([isActive])
  @@map("prompt_improvements")
}

// ===========================================
// AUTOMATIC QUALITY ANALYSIS SYSTEM
// ===========================================

// Queue for background image analysis jobs
model AnalysisJob {
  id            String   @id @default(cuid())
  generationId  String   @unique @map("generation_id")
  status        String   @default("pending") // pending, processing, completed, failed
  priority      Int      @default(0) // Higher = more urgent
  retryCount    Int      @default(0) @map("retry_count")
  errorMessage  String?  @map("error_message")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("analysis_jobs")
}

// Store AI vision analysis results for each generation
model ImageAnalysis {
  id                  String   @id @default(cuid())
  generationId        String   @unique @map("generation_id")

  // What the AI detected in the image
  detectedObjects     String?  @map("detected_objects") // JSON: ["sword", "shield", "warrior"]
  detectedStyle       String?  @map("detected_style") // pixel-art, anime, realistic, etc.
  detectedColors      String?  @map("detected_colors") // JSON: ["#ff0000", "#00ff00"]
  detectedMood        String?  @map("detected_mood") // dark, bright, colorful, etc.

  // Quality metrics
  qualityScore        Float    @default(0) @map("quality_score") // 0-100
  styleAccuracy       Float    @default(0) @map("style_accuracy") // How well it matches requested style
  promptAlignment     Float    @default(0) @map("prompt_alignment") // 0-100 how well image matches prompt

  // Hallucination detection
  hasHallucination    Boolean  @default(false) @map("has_hallucination")
  hallucinationType   String?  @map("hallucination_type") // missing_element, wrong_element, style_mismatch
  hallucinationDetails String? @map("hallucination_details") // JSON with specifics

  // What was requested vs what was generated
  requestedElements   String?  @map("requested_elements") // JSON: parsed from prompt
  missingElements     String?  @map("missing_elements") // JSON: what's missing
  extraElements       String?  @map("extra_elements") // JSON: unwanted additions

  // AI's suggestions for improvement
  suggestedFix        String?  @map("suggested_fix") // How to improve the prompt
  confidenceScore     Float    @default(0) @map("confidence_score") // How sure AI is

  rawAnalysis         String?  @map("raw_analysis") // Full AI response JSON
  modelUsed           String?  @map("model_used") // gpt-4-vision, claude-3, etc.
  analysisCost        Float    @default(0) @map("analysis_cost") // Cost in USD

  createdAt           DateTime @default(now()) @map("created_at")

  // Relation to generation
  generation          Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
  @@index([hasHallucination])
  @@index([promptAlignment])
  @@index([qualityScore])
  @@map("image_analyses")
}

// Track patterns of hallucinations to prevent them
model HallucinationPattern {
  id                String   @id @default(cuid())
  categoryId        String   @map("category_id")
  subcategoryId     String   @map("subcategory_id")
  styleId           String   @map("style_id")

  // Pattern info
  triggerKeywords   String   @map("trigger_keywords") // JSON: words that cause issues
  hallucinationType String   @map("hallucination_type")
  occurrenceCount   Int      @default(1) @map("occurrence_count")

  // The fix
  preventionPrompt  String?  @map("prevention_prompt") // Added to prompt to prevent
  fixEffectiveness  Float    @default(0) @map("fix_effectiveness") // 0-100%

  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([categoryId, subcategoryId, styleId])
  @@index([hallucinationType])
  @@index([occurrenceCount])
  @@map("hallucination_patterns")
}

// ===========================================
// VERIFICATION SYSTEM - Fix verification records
// ===========================================
model VerificationRecord {
  id                        String   @id @default(cuid())

  // Original generation that had the issue
  originalGenerationId      String   @map("original_generation_id")
  originalGeneration        Generation @relation(fields: [originalGenerationId], references: [id], onDelete: Cascade)

  // Verification image (new generation with fixes)
  verificationImageUrl      String   @map("verification_image_url")

  // What we're testing
  originalHallucinationType String   @map("original_hallucination_type")
  appliedFixes              String   @map("applied_fixes") // JSON array of fixes that were applied

  // Results
  newHasHallucination       Boolean  @map("new_has_hallucination")
  newHallucinationType      String?  @map("new_hallucination_type")
  originalAlignment         Float    @map("original_alignment")
  newAlignment              Float    @map("new_alignment")

  // Status: VERIFIED_FIXED, STILL_BROKEN, DIFFERENT_ISSUE, IMPROVED
  status                    String
  message                   String

  createdAt                 DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([originalHallucinationType])
  @@index([createdAt])
  @@map("verification_records")
}

// ===========================================
// EMAIL MARKETING SYSTEM
// ===========================================

// Log all sent emails for tracking and analytics
model EmailLog {
  id            String   @id @default(cuid())
  userId        String?  @map("user_id") // Nullable for non-user emails
  email         String   // Recipient email
  type          String   // WELCOME, RE_ENGAGEMENT, PROMO, SYSTEM
  subject       String
  status        String   @default("sent") // sent, failed, bounced, opened, clicked
  messageId     String?  @map("message_id") // Resend message ID
  errorMessage  String?  @map("error_message")
  metadata      Json?    // Extra data (promo code, campaign name, etc.)
  openedAt      DateTime? @map("opened_at")
  clickedAt     DateTime? @map("clicked_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([email])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

// Store prompt templates that work well (learned from data)
model OptimizedPrompt {
  id                String   @id @default(cuid())
  categoryId        String   @map("category_id")
  subcategoryId     String   @map("subcategory_id")
  styleId           String   @map("style_id")

  // The optimized template
  promptTemplate    String   @map("prompt_template") // Template with {placeholders}
  requiredKeywords  String?  @map("required_keywords") // JSON: must include these
  avoidKeywords     String?  @map("avoid_keywords") // JSON: never use these

  // Performance metrics
  avgQualityScore   Float    @default(0) @map("avg_quality_score")
  avgPromptAlignment Float   @default(0) @map("avg_prompt_alignment")
  successCount      Int      @default(0) @map("success_count")
  failureCount      Int      @default(0) @map("failure_count")

  // Version control
  version           Int      @default(1)
  previousVersion   String?  @map("previous_version") // ID of previous template

  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([categoryId, subcategoryId, styleId, version])
  @@index([categoryId])
  @@index([avgQualityScore])
  @@index([isActive])
  @@map("optimized_prompts")
}
